# üê≥ Deploy com Docker e Portainer

Guia completo para fazer deploy do **My Karaoke Party** usando Docker e Portainer no seu VPS Ubuntu.

## üìã √çndice

- [Pr√©-requisitos](#pr√©-requisitos)
- [Prepara√ß√£o do Servidor](#prepara√ß√£o-do-servidor)
- [Configura√ß√£o do Portainer](#configura√ß√£o-do-portainer)
- [Deploy da Aplica√ß√£o](#deploy-da-aplica√ß√£o)
- [Configura√ß√£o de Vari√°veis](#configura√ß√£o-de-vari√°veis)
- [Deploy via Git](#deploy-via-git)
- [Deploy via Upload](#deploy-via-upload)
- [Verifica√ß√£o e Logs](#verifica√ß√£o-e-logs)
- [Atualiza√ß√µes](#atualiza√ß√µes)
- [Troubleshooting](#troubleshooting)

---

## üîß Pr√©-requisitos

### No Servidor VPS Ubuntu 20.04

- Docker Engine instalado
- Docker Compose instalado
- Portainer rodando
- Acesso SSH ao servidor
- Portas abertas: 80, 443, 3000, 9000 (Portainer)

---

## üöÄ Prepara√ß√£o do Servidor

### 1. Instalar Docker

```bash
# Atualizar sistema
sudo apt update && sudo apt upgrade -y

# Instalar depend√™ncias
sudo apt install -y apt-transport-https ca-certificates curl software-properties-common

# Adicionar reposit√≥rio Docker
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# Instalar Docker
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io

# Adicionar usu√°rio ao grupo docker
sudo usermod -aG docker $USER
newgrp docker

# Verificar instala√ß√£o
docker --version
```

### 2. Instalar Docker Compose

```bash
# Baixar Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

# Dar permiss√£o de execu√ß√£o
sudo chmod +x /usr/local/bin/docker-compose

# Verificar instala√ß√£o
docker-compose --version
```

### 3. Instalar Portainer

```bash
# Criar volume para dados do Portainer
docker volume create portainer_data

# Iniciar Portainer
docker run -d \
  -p 9000:9000 \
  -p 9443:9443 \
  --name portainer \
  --restart=always \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v portainer_data:/data \
  portainer/portainer-ce:latest

# Verificar se est√° rodando
docker ps | grep portainer
```

### 4. Acessar Portainer

1. Abra o navegador: `https://seu-ip:9443`
2. Crie o usu√°rio admin na primeira vez
3. Conecte ao ambiente Docker local

---

## üéØ Configura√ß√£o do Portainer

### Criar Stack no Portainer

1. **Login no Portainer**: `https://seu-ip:9443`
2. **Menu**: `Stacks` ‚Üí `Add stack`
3. **Nome da Stack**: `my-karaoke-party`

---

## üì¶ Deploy da Aplica√ß√£o

### M√©todo 1: Deploy via Git (Recomendado)

#### No Portainer:

1. **Build method**: Selecione `Repository`
2. **Repository URL**: `https://github.com/flaviokosta79/my-karaoke-party`
3. **Reference**: `refs/heads/main`
4. **Compose path**: `docker-compose.yml`

#### Configurar Environment Variables:

```env
DB_PASSWORD=sua_senha_postgresql_segura
YOUTUBE_API_KEY=AIzaSyD2ANlmuTx-oCKcmeV4GbwnR2JMA99rI1E
NEXT_PUBLIC_APP_URL=http://seu-dominio.com
```

5. **Deploy the stack**: Clique em `Deploy the stack`

---

### M√©todo 2: Deploy via Upload

#### 1. Preparar arquivos no servidor

```bash
# Criar diret√≥rio
mkdir -p ~/apps/my-karaoke-party
cd ~/apps/my-karaoke-party

# Clonar reposit√≥rio
git clone https://github.com/flaviokosta79/my-karaoke-party.git .

# Criar arquivo .env
nano .env
```

#### 2. Configurar `.env`:

```env
DB_PASSWORD=sua_senha_postgresql_segura
YOUTUBE_API_KEY=AIzaSyD2ANlmuTx-oCKcmeV4GbwnR2JMA99rI1E
NEXT_PUBLIC_APP_URL=http://seu-dominio.com
```

#### 3. No Portainer:

1. **Build method**: Selecione `Upload`
2. **Upload**: Fa√ßa upload do `docker-compose.yml`
3. **Environment variables**: Cole as vari√°veis do `.env`
4. **Deploy the stack**

---

### M√©todo 3: Deploy via Web Editor

#### No Portainer:

1. **Build method**: Selecione `Web editor`
2. Cole o conte√∫do do `docker-compose.yml`:

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: karaoke-postgres
    restart: always
    environment:
      POSTGRES_USER: mykaraoke
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: mykaraoke_party
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mykaraoke"]
      interval: 10s
      timeout: 5s
      retries: 5

  app:
    build:
      context: https://github.com/flaviokosta79/my-karaoke-party.git
      dockerfile: Dockerfile
    container_name: karaoke-app
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://mykaraoke:${DB_PASSWORD}@postgres:5432/mykaraoke_party
      YOUTUBE_API_KEY: ${YOUTUBE_API_KEY}
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL}
      NODE_ENV: production
    ports:
      - "3000:3000"

  cleanup-cron:
    image: curlimages/curl:latest
    container_name: karaoke-cleanup
    restart: always
    depends_on:
      - app
    entrypoint: /bin/sh
    command: >
      -c "while true; do
        sleep 600;
        curl -f http://app:3000/api/cron/cleanup-parties || echo 'Cleanup failed';
      done"

volumes:
  postgres_data:
```

3. **Environment variables**:

```env
DB_PASSWORD=sua_senha_postgresql_segura
YOUTUBE_API_KEY=AIzaSyD2ANlmuTx-oCKcmeV4GbwnR2JMA99rI1E
NEXT_PUBLIC_APP_URL=http://seu-dominio.com
```

4. **Deploy the stack**

---

## üîê Configura√ß√£o de Vari√°veis

### Vari√°veis Obrigat√≥rias:

| Vari√°vel | Descri√ß√£o | Exemplo |
|----------|-----------|---------|
| `DB_PASSWORD` | Senha do PostgreSQL | `minha_senha_super_segura_123` |
| `YOUTUBE_API_KEY` | Chave da API do YouTube | `AIzaSyD2ANlmuTx-oCKcmeV4GbwnR2JMA99rI1E` |
| `NEXT_PUBLIC_APP_URL` | URL p√∫blica da aplica√ß√£o | `http://karaoke.seudominio.com` ou `http://seu-ip:3000` |

### Como obter a YouTube API Key:

1. Acesse: https://console.cloud.google.com/
2. Crie um novo projeto
3. Ative a **YouTube Data API v3**
4. Crie credenciais ‚Üí Chave de API
5. Copie a chave gerada

---

## üìä Verifica√ß√£o e Logs

### No Portainer:

1. **Stacks** ‚Üí `my-karaoke-party`
2. Verifique status dos containers:
   - ‚úÖ `karaoke-postgres` - healthy
   - ‚úÖ `karaoke-app` - running
   - ‚úÖ `karaoke-cleanup` - running

### Ver logs:

**Pelo Portainer:**
1. Clique no container
2. Aba `Logs`
3. Acompanhe em tempo real

**Pelo Terminal:**
```bash
# Logs da aplica√ß√£o
docker logs -f karaoke-app

# Logs do PostgreSQL
docker logs -f karaoke-postgres

# Logs do cleanup cron
docker logs -f karaoke-cleanup

# Logs de todos
docker-compose logs -f
```

### Verificar aplica√ß√£o:

```bash
# Testar se est√° respondendo
curl http://localhost:3000

# Testar endpoint de cleanup
curl http://localhost:3000/api/cron/cleanup-parties
```

---

## üîÑ Atualiza√ß√µes

### Pelo Portainer:

1. **Stacks** ‚Üí `my-karaoke-party`
2. **Editor** (√≠cone de l√°pis)
3. Se usar Git:
   - Marque `Re-pull image and redeploy`
   - Clique `Update the stack`
4. Se usar Web editor:
   - N√£o precisa mudar nada
   - Clique `Update the stack`

### Pelo Terminal:

```bash
cd ~/apps/my-karaoke-party

# Atualizar c√≥digo
git pull origin main

# Rebuild e restart
docker-compose down
docker-compose up -d --build

# Ou usar Portainer para ver os logs durante o processo
```

---

## üåê Configurar Dom√≠nio e SSL

### Op√ß√£o 1: Usar Nginx Externo

```bash
# Instalar Nginx no host
sudo apt install -y nginx certbot python3-certbot-nginx

# Criar configura√ß√£o
sudo nano /etc/nginx/sites-available/karaoke
```

```nginx
server {
    listen 80;
    server_name karaoke.seudominio.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

```bash
# Ativar site
sudo ln -s /etc/nginx/sites-available/karaoke /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx

# Instalar SSL
sudo certbot --nginx -d karaoke.seudominio.com
```

### Op√ß√£o 2: Usar container Nginx (inclu√≠do no docker-compose)

```bash
# Adicionar profile no docker-compose.yml
docker-compose --profile with-nginx up -d
```

---

## üêõ Troubleshooting

### Container n√£o inicia:

```bash
# Ver logs detalhados
docker logs karaoke-app

# Ver status
docker ps -a

# Reiniciar container espec√≠fico
docker restart karaoke-app
```

### Erro de conex√£o com banco:

```bash
# Verificar se PostgreSQL est√° healthy
docker ps

# Entrar no container do PostgreSQL
docker exec -it karaoke-postgres psql -U mykaraoke -d mykaraoke_party

# Listar tabelas
\dt

# Sair
\q
```

### Build falha:

```bash
# Limpar cache do Docker
docker system prune -a

# Rebuild for√ßado
docker-compose build --no-cache
docker-compose up -d
```

### Aplica√ß√£o n√£o responde:

```bash
# Verificar portas
sudo netstat -tlnp | grep 3000

# Verificar logs
docker logs -f karaoke-app

# Restart completo
docker-compose restart
```

### Cleanup n√£o est√° funcionando:

```bash
# Ver logs do cron
docker logs -f karaoke-cleanup

# Testar manualmente
curl http://localhost:3000/api/cron/cleanup-parties

# Entrar no container
docker exec -it karaoke-cleanup sh
```

---

## üì± Acesso √† Aplica√ß√£o

Depois do deploy bem-sucedido:

- **Aplica√ß√£o**: `http://seu-ip:3000` ou `https://seu-dominio.com`
- **Portainer**: `https://seu-ip:9443`

---

## üîí Seguran√ßa

### Recomenda√ß√µes:

1. **Firewall (UFW)**:
```bash
sudo ufw allow 22/tcp      # SSH
sudo ufw allow 80/tcp      # HTTP
sudo ufw allow 443/tcp     # HTTPS
sudo ufw allow 9443/tcp    # Portainer (pode restringir por IP)
sudo ufw enable
```

2. **Senha forte do banco**: Gere com `openssl rand -base64 32`

3. **N√£o exponha porta 5432**: J√° est√° configurado para uso interno apenas

4. **Mantenha Docker atualizado**:
```bash
sudo apt update
sudo apt upgrade docker-ce docker-ce-cli
```

5. **Backups regulares**:
```bash
# Backup do banco
docker exec karaoke-postgres pg_dump -U mykaraoke mykaraoke_party > backup-$(date +%Y%m%d).sql

# Backup do volume
docker run --rm -v my-karaoke-party_postgres_data:/data -v $(pwd):/backup alpine tar czf /backup/postgres-backup-$(date +%Y%m%d).tar.gz /data
```

---

## üì¶ Estrutura dos Containers

```
my-karaoke-party (stack)
‚îÇ
‚îú‚îÄ‚îÄ karaoke-postgres (PostgreSQL 15)
‚îÇ   ‚îî‚îÄ‚îÄ Volume: postgres_data
‚îÇ   ‚îî‚îÄ‚îÄ Port: 5432 (interno)
‚îÇ   ‚îî‚îÄ‚îÄ Health check: pg_isready
‚îÇ
‚îú‚îÄ‚îÄ karaoke-app (Next.js)
‚îÇ   ‚îî‚îÄ‚îÄ Port: 3000 (externo)
‚îÇ   ‚îî‚îÄ‚îÄ Depends on: postgres
‚îÇ   ‚îî‚îÄ‚îÄ Auto migrations on startup
‚îÇ
‚îî‚îÄ‚îÄ karaoke-cleanup (Cron)
    ‚îî‚îÄ‚îÄ Curl a cada 10 minutos
    ‚îî‚îÄ‚îÄ Endpoint: /api/cron/cleanup-parties
    ‚îî‚îÄ‚îÄ Depends on: app
```

---

## ‚úÖ Checklist de Deploy

- [ ] Docker e Docker Compose instalados
- [ ] Portainer rodando e acess√≠vel
- [ ] Stack criada no Portainer
- [ ] Vari√°veis de ambiente configuradas
- [ ] Build da imagem conclu√≠do
- [ ] Containers rodando (postgres, app, cleanup)
- [ ] Migrations executadas automaticamente
- [ ] Aplica√ß√£o acess√≠vel em `http://ip:3000`
- [ ] Endpoint de cleanup funcionando
- [ ] Nginx configurado (opcional)
- [ ] SSL instalado (opcional)
- [ ] Firewall configurado
- [ ] Backup configurado

---

## üéâ Deploy Completo!

Sua aplica√ß√£o **My Karaoke Party** agora est√° rodando em produ√ß√£o com Docker e Portainer!

**Stack rodando:**
- ‚úÖ PostgreSQL 15 (banco de dados)
- ‚úÖ Next.js App (aplica√ß√£o)
- ‚úÖ Cleanup Cron (limpeza autom√°tica a cada 10 minutos)

**Sistema de auto-cleanup ativo:**
- Festas inativas por 20+ minutos ser√£o fechadas automaticamente
- Cron job rodando dentro do container
- Logs dispon√≠veis no Portainer

---

## üìö Recursos Adicionais

- [Docker Docs](https://docs.docker.com/)
- [Portainer Docs](https://docs.portainer.io/)
- [PostgreSQL Docker](https://hub.docker.com/_/postgres)
- [Next.js Docker](https://nextjs.org/docs/deployment#docker-image)
